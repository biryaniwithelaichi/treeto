import{a9 as N,aa as p,ab as D,ac as O}from"./index-Cq7rgpS1.js";try{let a=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},e=new a.Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="d7e084ba-d05d-4952-ab78-8bf7bab3ff20",a._sentryDebugIdIdentifier="sentry-dbid-d7e084ba-d05d-4952-ab78-8bf7bab3ff20")}catch{}var w=function(a,e){return w=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t}||function(r,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])},w(a,e)};function U(a,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");w(a,e);function r(){this.constructor=a}a.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}var y=function(){return y=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++){r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},y.apply(this,arguments)};function l(a){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&a[e],t=0;if(r)return r.call(a);if(a&&typeof a.length=="number")return{next:function(){return a&&t>=a.length&&(a=void 0),{value:a&&a[t++],done:!a}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function k(a,e){var r=typeof Symbol=="function"&&a[Symbol.iterator];if(!r)return a;var t=r.call(a),n,o=[],i;try{for(;(e===void 0||e-- >0)&&!(n=t.next()).done;)o.push(n.value)}catch(c){i={error:c}}finally{try{n&&!n.done&&(r=t.return)&&r.call(t)}finally{if(i)throw i.error}}return o}function P(a,e,r){if(arguments.length===2)for(var t=0,n=e.length,o;t<n;t++)(o||!(t in e))&&(o||(o=Array.prototype.slice.call(e,0,t)),o[t]=e[t]);return a.concat(o||Array.prototype.slice.call(e))}var s={IS:"is",IS_NOT:"is not",CONTAINS:"contains",DOES_NOT_CONTAIN:"does not contain",LESS_THAN:"less",LESS_THAN_EQUALS:"less or equal",GREATER_THAN:"greater",GREATER_THAN_EQUALS:"greater or equal",VERSION_LESS_THAN:"version less",VERSION_LESS_THAN_EQUALS:"version less or equal",VERSION_GREATER_THAN:"version greater",VERSION_GREATER_THAN_EQUALS:"version greater or equal",SET_IS:"set is",SET_IS_NOT:"set is not",SET_CONTAINS:"set contains",SET_DOES_NOT_CONTAIN:"set does not contain",SET_CONTAINS_ANY:"set contains any",SET_DOES_NOT_CONTAIN_ANY:"set does not contain any",REGEX_MATCH:"regex match",REGEX_DOES_NOT_MATCH:"regex does not match"},j=function(a){for(var e=[],r=0,t=0;t<a.length;t++){var n=a.charCodeAt(t);n<128?e[r++]=n:n<2048?(e[r++]=n>>6|192,e[r++]=n&63|128):(n&64512)==55296&&t+1<a.length&&(a.charCodeAt(t+1)&64512)==56320?(n=65536+((n&1023)<<10)+(a.charCodeAt(++t)&1023),e[r++]=n>>18|240,e[r++]=n>>12&63|128,e[r++]=n>>6&63|128,e[r++]=n&63|128):(e[r++]=n>>12|224,e[r++]=n>>6&63|128,e[r++]=n&63|128)}return Uint8Array.from(e)},R=-862048943,I=461845907,b=15,M=13,Q=5,B=-430675100,F=function(a,e){e===void 0&&(e=0);for(var r=j(a),t=r.length,n=t>>2,o=e,i=0;i<n;i++){var c=i<<2,v=q(r,c);o=X(v,o)}var f=n<<2,u=0;switch(t-f){case 3:u^=r[f+2]<<16,u^=r[f+1]<<8,u^=r[f],u=Math.imul(u,R),u=g(u,b),u=Math.imul(u,I),o^=u;break;case 2:u^=r[f+1]<<8,u^=r[f],u=Math.imul(u,R),u=g(u,b),u=Math.imul(u,I),o^=u;break;case 1:u^=r[f],u=Math.imul(u,R),u=g(u,b),u=Math.imul(u,I),o^=u;break}return o^=t,Y(o)>>>0},X=function(a,e){var r=a,t=e;return r=Math.imul(r,R),r=g(r,b),r=Math.imul(r,I),t^=r,t=g(t,M),t=Math.imul(t,Q),t+B|0},Y=function(a){var e=a;return e^=e>>>16,e=Math.imul(e,-2048144789),e^=e>>>13,e=Math.imul(e,-1028477387),e^=e>>>16,e},g=function(a,e,r){r===void 0&&(r=32),e>r&&(e=e%r);var t=4294967295<<r-e>>>0,n=(a&t)>>>0>>>r-e>>>0;return(a<<e|n)>>>0},q=function(a,e){e===void 0&&(e=0);var r=a[e]<<24|a[e+1]<<16|a[e+2]<<8|a[e+3];return J(r)},J=function(a){return(a&-16777216)>>>24|(a&16711680)>>>8|(a&65280)<<8|(a&255)<<24},L=function(a,e){var r,t;if(!(!e||e.length===0)){try{for(var n=l(e),o=n.next();!o.done;o=n.next()){var i=o.value;if(!i||!a||typeof a!="object")return;a=a[i]}}catch(c){r={error:c}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(r)throw r.error}}if(a)return a}},z="(\\d+)\\.(\\d+)",K="(\\d+)",$="(-(([-\\w]+\\.?)*))?",W="^".concat(z,"(\\.").concat(K).concat($,")?$"),Z=function(){function a(e,r,t,n){n===void 0&&(n=void 0),this.major=e,this.minor=r,this.patch=t,this.preRelease=n}return a.parse=function(e){if(e){var r=new RegExp(W).exec(e);if(r){var t=Number(r[1]),n=Number(r[2]);if(!(isNaN(t)||isNaN(n))){var o=Number(r[4])||0,i=r[5]||void 0;return new a(t,n,o,i)}}}},a.prototype.compareTo=function(e){return this.major>e.major?1:this.major<e.major?-1:this.minor>e.minor?1:this.minor<e.minor?-1:this.patch>e.patch?1:this.patch<e.patch||this.preRelease&&!e.preRelease?-1:!this.preRelease&&e.preRelease?1:this.preRelease&&e.preRelease?this.preRelease>e.preRelease?1:this.preRelease<e.preRelease?-1:0:0},a}(),V=function(){function a(){}return a.prototype.evaluate=function(e,r){var t,n,o={},i={context:e,result:o};try{for(var c=l(r),v=c.next();!v.done;v=c.next()){var f=v.value,u=this.evaluateFlag(i,f);u&&(o[f.key]=u)}}catch(S){t={error:S}}finally{try{v&&!v.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return o},a.prototype.evaluateFlag=function(e,r){var t,n,o;try{for(var i=l(r.segments),c=i.next();!c.done;c=i.next()){var v=c.value;if(o=this.evaluateSegment(e,r,v),o){var f=y(y(y({},r.metadata),v.metadata),o.metadata);o=y(y({},o),{metadata:f});break}}}catch(u){t={error:u}}finally{try{c&&!c.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return o},a.prototype.evaluateSegment=function(e,r,t){var n,o,i,c;if(!t.conditions){var v=this.bucket(e,t);return v!==void 0?r.variants[v]:void 0}try{for(var f=l(t.conditions),u=f.next();!u.done;u=f.next()){var S=u.value,h=!0;try{for(var E=(i=void 0,l(S)),d=E.next();!d.done;d=E.next()){var T=d.value;if(h=this.matchCondition(e,T),!h)break}}catch(A){i={error:A}}finally{try{d&&!d.done&&(c=E.return)&&c.call(E)}finally{if(i)throw i.error}}if(h){var v=this.bucket(e,t);return v!==void 0?r.variants[v]:void 0}}}catch(A){n={error:A}}finally{try{u&&!u.done&&(o=f.return)&&o.call(f)}finally{if(n)throw n.error}}},a.prototype.matchCondition=function(e,r){var t=L(e,r.selector);if(t)if(this.isSetOperator(r.op)){var n=this.coerceStringArray(t);return n?this.matchSet(n,r.op,r.values):!1}else{var o=this.coerceString(t);return o!==void 0?this.matchString(o,r.op,r.values):!1}else return this.matchNull(r.op,r.values)},a.prototype.getHash=function(e){return F(e)},a.prototype.bucket=function(e,r){var t,n,o,i;if(!r.bucket)return r.variant;var c=this.coerceString(L(e,r.bucket.selector));if(!c||c.length===0)return r.variant;var v="".concat(r.bucket.salt,"/").concat(c),f=this.getHash(v),u=f%100,S=Math.floor(f/100);try{for(var h=l(r.bucket.allocations),E=h.next();!E.done;E=h.next()){var d=E.value,T=d.range[0],A=d.range[1];if(u>=T&&u<A)try{for(var m=(o=void 0,l(d.distributions)),_=m.next();!_.done;_=m.next()){var x=_.value,H=x.range[0],G=x.range[1];if(S>=H&&S<G)return x.variant}}catch(C){o={error:C}}finally{try{_&&!_.done&&(i=m.return)&&i.call(m)}finally{if(o)throw o.error}}}}catch(C){t={error:C}}finally{try{E&&!E.done&&(n=h.return)&&n.call(h)}finally{if(t)throw t.error}}return r.variant},a.prototype.matchNull=function(e,r){var t=this.containsNone(r);switch(e){case s.IS:case s.CONTAINS:case s.LESS_THAN:case s.LESS_THAN_EQUALS:case s.GREATER_THAN:case s.GREATER_THAN_EQUALS:case s.VERSION_LESS_THAN:case s.VERSION_LESS_THAN_EQUALS:case s.VERSION_GREATER_THAN:case s.VERSION_GREATER_THAN_EQUALS:case s.SET_IS:case s.SET_CONTAINS:case s.SET_CONTAINS_ANY:return t;case s.IS_NOT:case s.DOES_NOT_CONTAIN:case s.SET_DOES_NOT_CONTAIN:case s.SET_DOES_NOT_CONTAIN_ANY:return!t;default:return!1}},a.prototype.matchSet=function(e,r,t){switch(r){case s.SET_IS:return this.setEquals(e,t);case s.SET_IS_NOT:return!this.setEquals(e,t);case s.SET_CONTAINS:return this.matchesSetContainsAll(e,t);case s.SET_DOES_NOT_CONTAIN:return!this.matchesSetContainsAll(e,t);case s.SET_CONTAINS_ANY:return this.matchesSetContainsAny(e,t);case s.SET_DOES_NOT_CONTAIN_ANY:return!this.matchesSetContainsAny(e,t);default:return!1}},a.prototype.matchString=function(e,r,t){var n=this;switch(r){case s.IS:return this.matchesIs(e,t);case s.IS_NOT:return!this.matchesIs(e,t);case s.CONTAINS:return this.matchesContains(e,t);case s.DOES_NOT_CONTAIN:return!this.matchesContains(e,t);case s.LESS_THAN:case s.LESS_THAN_EQUALS:case s.GREATER_THAN:case s.GREATER_THAN_EQUALS:return this.matchesComparable(e,r,t,function(o){return n.parseNumber(o)},this.comparator);case s.VERSION_LESS_THAN:case s.VERSION_LESS_THAN_EQUALS:case s.VERSION_GREATER_THAN:case s.VERSION_GREATER_THAN_EQUALS:return this.matchesComparable(e,r,t,function(o){return Z.parse(o)},this.versionComparator);case s.REGEX_MATCH:return this.matchesRegex(e,t);case s.REGEX_DOES_NOT_MATCH:return!this.matchesRegex(e,t);default:return!1}},a.prototype.matchesIs=function(e,r){if(this.containsBooleans(r)){var t=e.toLowerCase();if(t==="true"||t==="false")return r.some(function(n){return n.toLowerCase()===t})}return r.some(function(n){return e===n})},a.prototype.matchesContains=function(e,r){var t,n;try{for(var o=l(r),i=o.next();!i.done;i=o.next()){var c=i.value;if(e.toLowerCase().includes(c.toLowerCase()))return!0}}catch(v){t={error:v}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!1},a.prototype.matchesComparable=function(e,r,t,n,o){var i=this,c=n(e),v=t.map(function(f){return n(f)}).filter(function(f){return f!==void 0});return c===void 0||v.length===0?t.some(function(f){return i.comparator(e,r,f)}):v.some(function(f){return o(c,r,f)})},a.prototype.comparator=function(e,r,t){switch(r){case s.LESS_THAN:case s.VERSION_LESS_THAN:return e<t;case s.LESS_THAN_EQUALS:case s.VERSION_LESS_THAN_EQUALS:return e<=t;case s.GREATER_THAN:case s.VERSION_GREATER_THAN:return e>t;case s.GREATER_THAN_EQUALS:case s.VERSION_GREATER_THAN_EQUALS:return e>=t;default:return!1}},a.prototype.versionComparator=function(e,r,t){var n=e.compareTo(t);switch(r){case s.LESS_THAN:case s.VERSION_LESS_THAN:return n<0;case s.LESS_THAN_EQUALS:case s.VERSION_LESS_THAN_EQUALS:return n<=0;case s.GREATER_THAN:case s.VERSION_GREATER_THAN:return n>0;case s.GREATER_THAN_EQUALS:case s.VERSION_GREATER_THAN_EQUALS:return n>=0;default:return!1}},a.prototype.matchesRegex=function(e,r){return r.some(function(t){return!!new RegExp(t).exec(e)})},a.prototype.containsNone=function(e){return e.some(function(r){return r==="(none)"})},a.prototype.containsBooleans=function(e){return e.some(function(r){switch(r.toLowerCase()){case"true":case"false":return!0;default:return!1}})},a.prototype.parseNumber=function(e){var r;return(r=Number(e))!==null&&r!==void 0?r:void 0},a.prototype.coerceString=function(e){if(e)return typeof e=="object"?JSON.stringify(e):String(e)},a.prototype.coerceStringArray=function(e){var r=this;if(Array.isArray(e)){var t=e;return t.map(function(i){return r.coerceString(i)}).filter(Boolean)}var n=String(e);try{var o=JSON.parse(n);if(Array.isArray(o)){var t=e;return t.map(function(c){return r.coerceString(c)}).filter(Boolean)}else return}catch{return}},a.prototype.isSetOperator=function(e){switch(e){case s.SET_IS:case s.SET_IS_NOT:case s.SET_CONTAINS:case s.SET_DOES_NOT_CONTAIN:case s.SET_CONTAINS_ANY:case s.SET_DOES_NOT_CONTAIN_ANY:return!0;default:return!1}},a.prototype.setEquals=function(e,r){var t=new Set(e),n=new Set(r);return t.size===n.size&&P([],k(n),!1).every(function(o){return t.has(o)})},a.prototype.matchesSetContainsAll=function(e,r){var t,n;if(e.length<r.length)return!1;try{for(var o=l(r),i=o.next();!i.done;i=o.next()){var c=i.value;if(!this.matchesIs(c,e))return!1}}catch(v){t={error:v}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!0},a.prototype.matchesSetContainsAny=function(e,r){var t,n;try{for(var o=l(r),i=o.next();!i.done;i=o.next()){var c=i.value;if(this.matchesIs(c,e))return!0}}catch(v){t={error:v}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!1},a}();typeof TextDecoder=="function"&&new TextDecoder;typeof TextEncoder=="function"&&new TextEncoder;const ee="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",re=Array.prototype.slice.call(ee);(a=>{let e={};return a.forEach((r,t)=>e[r]=t),e})(re);String.fromCharCode.bind(String);typeof Uint8Array.from=="function"&&Uint8Array.from.bind(Uint8Array);(function(a){U(e,a);function e(r,t){var n=a.call(this,t)||this;return n.statusCode=r,Object.setPrototypeOf(n,e.prototype),n}return e})(Error);var te=1e3*60*60*24*2,ne=function(){function a(){var e=this;this.dbs={},this.createStore=function(r){return N(e,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return[4,D(r,1,{upgrade:function(n){n.objectStoreNames.contains("eventTypesForSession")||n.createObjectStore("eventTypesForSession",{keyPath:"sessionId"})}})];case 1:return[2,t.sent()]}})})},this.openOrCreateDB=function(r){return N(e,void 0,void 0,function(){var t,n;return p(this,function(o){switch(o.label){case 0:return this.dbs&&this.dbs[r]?[2,this.dbs[r]]:(t="".concat(r.substring(0,10),"_amp_targeting"),[4,this.createStore(t)]);case 1:return n=o.sent(),this.dbs[r]=n,[2,n]}})})},this.updateEventListForSession=function(r){var t=r.sessionId,n=r.eventType,o=r.eventTime,i=r.loggerProvider,c=r.tx;return N(e,void 0,void 0,function(){var v,f,u,S,h,E,d;return p(this,function(T){switch(T.label){case 0:return T.trys.push([0,3,,4]),[4,c.store.get(t)];case 1:return v=T.sent(),f=v?v.eventTypes:{},u=f[n]||{},S=O(O({},f),(E={},E[n]=O(O({},u),(d={},d[o]={event_type:n},d)),E)),[4,c.store.put({sessionId:t,eventTypes:S})];case 2:return T.sent(),[2,S];case 3:return h=T.sent(),i.warn("Failed to store events for targeting ".concat(t,": ").concat(h)),[3,4];case 4:return[2,void 0]}})})},this.deleteOldSessionEventTypes=function(r){var t=r.currentSessionId,n=r.loggerProvider,o=r.tx;return N(e,void 0,void 0,function(){var i,c,v,f,u;return p(this,function(S){switch(S.label){case 0:return S.trys.push([0,6,,7]),[4,o.store.getAll()];case 1:i=S.sent(),c=0,S.label=2;case 2:return c<i.length?(v=i[c],f=Date.now()-v.sessionId,v.sessionId!==t&&f>te?[4,o.store.delete(v.sessionId)]:[3,4]):[3,5];case 3:S.sent(),S.label=4;case 4:return c++,[3,2];case 5:return[3,7];case 6:return u=S.sent(),n.warn("Failed to clear old session events for targeting: ".concat(u)),[3,7];case 7:return[2]}})})},this.storeEventTypeForSession=function(r){var t=r.loggerProvider,n=r.sessionId,o=r.eventType,i=r.eventTime,c=r.apiKey;return N(e,void 0,void 0,function(){var v,f,u,S;return p(this,function(h){switch(h.label){case 0:return h.trys.push([0,5,,6]),[4,this.openOrCreateDB(c)];case 1:return v=h.sent(),f=v.transaction("eventTypesForSession","readwrite"),f?[4,this.updateEventListForSession({sessionId:n,tx:f,loggerProvider:t,eventType:o,eventTime:i})]:[2];case 2:return u=h.sent(),[4,this.deleteOldSessionEventTypes({currentSessionId:n,tx:f,loggerProvider:t})];case 3:return h.sent(),[4,f.done];case 4:return h.sent(),[2,u];case 5:return S=h.sent(),t.warn("Failed to store events for targeting ".concat(n,": ").concat(S)),[3,6];case 6:return[2,void 0]}})})}}return a}(),ae=new ne,oe=function(){function a(){var e=this;this.evaluateTargeting=function(r){var t=r.apiKey,n=r.loggerProvider,o=r.event,i=r.sessionId,c=r.userProperties,v=r.deviceId,f=r.flag;return N(e,void 0,void 0,function(){var u,S,h,E,d;return p(this,function(T){switch(T.label){case 0:return o&&o.time?[4,ae.storeEventTypeForSession({loggerProvider:n,apiKey:t,sessionId:i,eventType:o.event_type,eventTime:o.time})]:[3,2];case 1:return S=T.sent(),[3,3];case 2:S=void 0,T.label=3;case 3:return u=S,h=u&&new Set(Object.keys(u)),E={session_id:i,event:o,event_types:h&&Array.from(h),user:{device_id:v,user_properties:c}},d=this.evaluationEngine.evaluate(E,[f]),[2,d]}})})},this.evaluationEngine=new V}return a}(),ie=function(){var a=new oe;return{evaluateTargeting:a.evaluateTargeting.bind(a)}};const se=ie();var ce=se.evaluateTargeting;export{ce as evaluateTargeting};
//# sourceMappingURL=index-C-8MaKJ4.js.map
