"use strict";var k=Object.defineProperty;var U=(e,t,n)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var A=(e,t,n)=>U(e,typeof t!="symbol"?t+"":t,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("url"),$=require("buffer"),W=require("http"),o=require("./index-B-kSrMS1.js");function p(e){return new Promise((t,n)=>{var a;const r=W.request({method:"GET",...e,hostname:(a=e.hostname)==null?void 0:a.replace(/^\[(.+)\]$/,"$1")});r.on("error",s=>{n(Object.assign(new o.ProviderError("Unable to connect to instance metadata service"),s)),r.destroy()}),r.on("timeout",()=>{n(new o.ProviderError("TimeoutError from instance metadata service")),r.destroy()}),r.on("response",s=>{const{statusCode:f=400}=s;(f<200||300<=f)&&(n(Object.assign(new o.ProviderError("Error response received from instance metadata service"),{statusCode:f})),r.destroy());const i=[];s.on("data",l=>{i.push(l)}),s.on("end",()=>{t($.Buffer.concat(i)),r.destroy()})}),r.end()})}const M=e=>!!e&&typeof e=="object"&&typeof e.AccessKeyId=="string"&&typeof e.SecretAccessKey=="string"&&typeof e.Token=="string"&&typeof e.Expiration=="string",P=e=>({accessKeyId:e.AccessKeyId,secretAccessKey:e.SecretAccessKey,sessionToken:e.Token,expiration:new Date(e.Expiration),...e.AccountId&&{accountId:e.AccountId}}),y=1e3,R=0,C=({maxRetries:e=R,timeout:t=y})=>({maxRetries:e,timeout:t}),v=(e,t)=>{let n=e();for(let r=0;r<t;r++)n=n.catch(e);return n},T="AWS_CONTAINER_CREDENTIALS_FULL_URI",m="AWS_CONTAINER_CREDENTIALS_RELATIVE_URI",h="AWS_CONTAINER_AUTHORIZATION_TOKEN",K=(e={})=>{const{timeout:t,maxRetries:n}=C(e);return()=>v(async()=>{const r=await j({logger:e.logger}),a=JSON.parse(await q(t,r));if(!M(a))throw new o.CredentialsProviderError("Invalid response received from instance metadata service.",{logger:e.logger});return P(a)},n)},q=async(e,t)=>(process.env[h]&&(t.headers={...t.headers,Authorization:process.env[h]}),(await p({...t,timeout:e})).toString()),B="169.254.170.2",G={localhost:!0,"127.0.0.1":!0},H={"http:":!0,"https:":!0},j=async({logger:e})=>{if(process.env[m])return{hostname:B,path:process.env[m]};if(process.env[T]){const t=x.parse(process.env[T]);if(!t.hostname||!(t.hostname in G))throw new o.CredentialsProviderError(`${t.hostname} is not a valid container metadata service hostname`,{tryNextLink:!1,logger:e});if(!t.protocol||!(t.protocol in H))throw new o.CredentialsProviderError(`${t.protocol} is not a valid container metadata service protocol`,{tryNextLink:!1,logger:e});return{...t,port:t.port?parseInt(t.port,10):void 0}}throw new o.CredentialsProviderError(`The container metadata credential provider cannot be used unless the ${m} or ${T} environment variable is set`,{tryNextLink:!1,logger:e})};class N extends o.CredentialsProviderError{constructor(n,r=!0){super(n,r);A(this,"tryNextLink");A(this,"name","InstanceMetadataV1FallbackError");this.tryNextLink=r,Object.setPrototypeOf(this,N.prototype)}}exports.Endpoint=void 0;(function(e){e.IPv4="http://169.254.169.254",e.IPv6="http://[fd00:ec2::254]"})(exports.Endpoint||(exports.Endpoint={}));const z="AWS_EC2_METADATA_SERVICE_ENDPOINT",J="ec2_metadata_service_endpoint",X={environmentVariableSelector:e=>e[z],configFileSelector:e=>e[J],default:void 0};var I;(function(e){e.IPv4="IPv4",e.IPv6="IPv6"})(I||(I={}));const Y="AWS_EC2_METADATA_SERVICE_ENDPOINT_MODE",Z="ec2_metadata_service_endpoint_mode",Q={environmentVariableSelector:e=>e[Y],configFileSelector:e=>e[Z],default:I.IPv4},b=async()=>o.parseUrl(await ee()||await te()),ee=async()=>o.loadConfig(X)(),te=async()=>{const e=await o.loadConfig(Q)();switch(e){case I.IPv4:return exports.Endpoint.IPv4;case I.IPv6:return exports.Endpoint.IPv6;default:throw new Error(`Unsupported endpoint mode: ${e}. Select from ${Object.values(I)}`)}},ne=5*60,re=5*60,ae="https://docs.aws.amazon.com/sdkref/latest/guide/feature-static-credentials.html",w=(e,t)=>{const n=ne+Math.floor(Math.random()*re),r=new Date(Date.now()+n*1e3);t.warn(`Attempting credential expiration extension due to a credential service availability issue. A refresh of these credentials will be attempted after ${new Date(r)}.
For more information, please visit: `+ae);const a=e.originalExpiration??e.expiration;return{...e,...a?{originalExpiration:a}:{},expiration:r}},oe=(e,t={})=>{const n=(t==null?void 0:t.logger)||console;let r;return async()=>{let a;try{a=await e(),a.expiration&&a.expiration.getTime()<Date.now()&&(a=w(a,n))}catch(s){if(r)n.warn("Credential renew failed: ",s),a=w(r,n);else throw s}return r=a,a}},F="/latest/meta-data/iam/security-credentials/",se="/latest/api/token",S="AWS_EC2_METADATA_V1_DISABLED",D="ec2_metadata_v1_disabled",O="x-aws-ec2-metadata-token",ie=(e={})=>oe(ce(e),{logger:e.logger}),ce=(e={})=>{let t=!1;const{logger:n,profile:r}=e,{timeout:a,maxRetries:s}=C(e),f=async(i,l)=>{var g;if(t||((g=l.headers)==null?void 0:g[O])==null){let c=!1,d=!1;const V=await o.loadConfig({environmentVariableSelector:E=>{const u=E[S];if(d=!!u&&u!=="false",u===void 0)throw new o.CredentialsProviderError(`${S} not set in env, checking config file next.`,{logger:e.logger});return d},configFileSelector:E=>{const u=E[D];return c=!!u&&u!=="false",c},default:!1},{profile:r})();if(e.ec2MetadataV1Disabled||V){const E=[];throw e.ec2MetadataV1Disabled&&E.push("credential provider initialization (runtime option ec2MetadataV1Disabled)"),c&&E.push(`config file profile (${D})`),d&&E.push(`process environment variable (${S})`),new N(`AWS EC2 Metadata v1 fallback has been blocked by AWS SDK configuration in the following: [${E.join(", ")}].`)}}const L=(await v(async()=>{let c;try{c=await le(l)}catch(d){throw d.statusCode===401&&(t=!1),d}return c},i)).trim();return v(async()=>{let c;try{c=await Ee(L,l,e)}catch(d){throw d.statusCode===401&&(t=!1),d}return c},i)};return async()=>{const i=await b();if(t)return n==null||n.debug("AWS SDK Instance Metadata","using v1 fallback (no token fetch)"),f(s,{...i,timeout:a});{let l;try{l=(await de({...i,timeout:a})).toString()}catch(_){if((_==null?void 0:_.statusCode)===400)throw Object.assign(_,{message:"EC2 Metadata token request returned error"});return(_.message==="TimeoutError"||[403,404,405].includes(_.statusCode))&&(t=!0),n==null||n.debug("AWS SDK Instance Metadata","using v1 fallback (initial)"),f(s,{...i,timeout:a})}return f(s,{...i,headers:{[O]:l},timeout:a})}}},de=async e=>p({...e,path:se,method:"PUT",headers:{"x-aws-ec2-metadata-token-ttl-seconds":"21600"}}),le=async e=>(await p({...e,path:F})).toString(),Ee=async(e,t,n)=>{const r=JSON.parse((await p({...t,path:F+e})).toString());if(!M(r))throw new o.CredentialsProviderError("Invalid response received from instance metadata service.",{logger:n.logger});return P(r)};exports.DEFAULT_MAX_RETRIES=R;exports.DEFAULT_TIMEOUT=y;exports.ENV_CMDS_AUTH_TOKEN=h;exports.ENV_CMDS_FULL_URI=T;exports.ENV_CMDS_RELATIVE_URI=m;exports.fromContainerMetadata=K;exports.fromInstanceMetadata=ie;exports.getInstanceMetadataEndpoint=b;exports.httpRequest=p;exports.providerConfigFromInit=C;
//# sourceMappingURL=index-CtynqzH8.js.map
