"use strict";var M=Object.defineProperty;var U=(e,s,o)=>s in e?M(e,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[s]=o;var D=(e,s,o)=>U(e,typeof s!="symbol"?s+"":s,o);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("./index-B-kSrMS1.js"),H=require("fs"),P=require("./getSSOTokenFromFile-c3UheaqJ.js"),q=require("./parseKnownFiles--W3Yg_Lv.js");class w extends r.ProviderError{constructor(o,n=!0){super(o,n);D(this,"name","TokenProviderError");Object.setPrototypeOf(this,w.prototype)}}const W=e=>Object.entries(e).filter(([s])=>s.startsWith(r.IniSectionType.SSO_SESSION+r.CONFIG_PREFIX_SEPARATOR)).reduce((s,[o,n])=>({...s,[o.substring(o.indexOf(r.CONFIG_PREFIX_SEPARATOR)+1)]:n}),{}),X=()=>({}),j=async(e={})=>r.slurpFile(e.configFilepath??r.getConfigFilepath()).then(r.parseIni).then(W).catch(X),K=e=>e&&(typeof e.sso_start_url=="string"||typeof e.sso_account_id=="string"||typeof e.sso_session=="string"||typeof e.sso_region=="string"||typeof e.sso_role_name=="string"),z=5*60*1e3,I="To refresh this SSO session run 'aws sso login' with the corresponding profile.",J=async(e,s={})=>{var i,c,t;const{SSOOIDCClient:o}=await Promise.resolve().then(()=>require("./index-CXDjP28J.js"));return new o(Object.assign({},s.clientConfig??{},{region:e??((i=s.clientConfig)==null?void 0:i.region),logger:((c=s.clientConfig)==null?void 0:c.logger)??((t=s.parentClientConfig)==null?void 0:t.logger)}))},V=async(e,s,o={})=>{const{CreateTokenCommand:n}=await Promise.resolve().then(()=>require("./index-CXDjP28J.js"));return(await J(s,o)).send(new n({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},$=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new w(`Token is expired. ${I}`,!1)},_=(e,s,o=!1)=>{if(typeof s>"u")throw new w(`Value not present for '${e}' in SSO Token${o?". Cannot refresh":""}. ${I}`,!1)},{writeFile:Y}=H.promises,B=(e,s)=>{const o=P.getSSOTokenFilepath(e),n=JSON.stringify(s,null,2);return Y(o,n)},L=new Date(0),Q=(e={})=>async({callerClientConfig:s}={})=>{var h;const o={...e,parentClientConfig:{...s,...e.parentClientConfig}};(h=o.logger)==null||h.debug("@aws-sdk/token-providers - fromSso");const n=await q.parseKnownFiles(o),i=r.getProfileName({profile:o.profile??(s==null?void 0:s.profile)}),c=n[i];if(c){if(!c.sso_session)throw new w(`Profile '${i}' is missing required property 'sso_session'.`)}else throw new w(`Profile '${i}' could not be found in shared credentials file.`,!1);const t=c.sso_session,d=(await j(o))[t];if(!d)throw new w(`Sso session '${t}' could not be found in shared credentials file.`,!1);for(const a of["sso_start_url","sso_region"])if(!d[a])throw new w(`Sso session '${t}' is missing required property '${a}'.`,!1);d.sso_start_url;const O=d.sso_region;let S;try{S=await P.getSSOTokenFromFile(t)}catch{throw new w(`The SSO session token associated with profile=${i} was not found or is invalid. ${I}`,!1)}_("accessToken",S.accessToken),_("expiresAt",S.expiresAt);const{accessToken:l,expiresAt:g}=S,f={token:l,expiration:new Date(g)};if(f.expiration.getTime()-Date.now()>z)return f;if(Date.now()-L.getTime()<30*1e3)return $(f),f;_("clientId",S.clientId,!0),_("clientSecret",S.clientSecret,!0),_("refreshToken",S.refreshToken,!0);try{L.setTime(Date.now());const a=await V(S,O,o);_("accessToken",a.accessToken),_("expiresIn",a.expiresIn);const T=new Date(Date.now()+a.expiresIn*1e3);try{await B(t,{...S,accessToken:a.accessToken,expiresAt:T.toISOString(),refreshToken:a.refreshToken})}catch{}return{token:a.accessToken,expiration:T}}catch{return $(f),f}},y=!1,b=async({ssoStartUrl:e,ssoSession:s,ssoAccountId:o,ssoRegion:n,ssoRoleName:i,ssoClient:c,clientConfig:t,parentClientConfig:p,profile:d,filepath:O,configFilepath:S,ignoreCache:l,logger:g})=>{let f;const h="To refresh this SSO session run aws sso login with the corresponding profile.";if(s)try{const u=await Q({profile:d,filepath:O,configFilepath:S,ignoreCache:l})();f={accessToken:u.token,expiresAt:new Date(u.expiration).toISOString()}}catch(u){throw new r.CredentialsProviderError(u.message,{tryNextLink:y,logger:g})}else try{f=await P.getSSOTokenFromFile(e)}catch{throw new r.CredentialsProviderError(`The SSO session associated with this profile is invalid. ${h}`,{tryNextLink:y,logger:g})}if(new Date(f.expiresAt).getTime()-Date.now()<=0)throw new r.CredentialsProviderError(`The SSO session associated with this profile has expired. ${h}`,{tryNextLink:y,logger:g});const{accessToken:a}=f,{SSOClient:T,GetRoleCredentialsCommand:x}=await Promise.resolve().then(()=>require("./loadSso-CPXuCLah.js")),k=c||new T(Object.assign({},t??{},{logger:(t==null?void 0:t.logger)??(p==null?void 0:p.logger),region:(t==null?void 0:t.region)??n}));let m;try{m=await k.send(new x({accountId:o,roleName:i,accessToken:a}))}catch(u){throw new r.CredentialsProviderError(u,{tryNextLink:y,logger:g})}const{roleCredentials:{accessKeyId:C,secretAccessKey:v,sessionToken:F,expiration:N,credentialScope:R,accountId:A}={}}=m;if(!C||!v||!F||!N)throw new r.CredentialsProviderError("SSO returns an invalid temporary credential.",{tryNextLink:y,logger:g});const E={accessKeyId:C,secretAccessKey:v,sessionToken:F,expiration:new Date(N),...R&&{credentialScope:R},...A&&{accountId:A}};return s?r.setCredentialFeature(E,"CREDENTIALS_SSO","s"):r.setCredentialFeature(E,"CREDENTIALS_SSO_LEGACY","u"),E},G=(e,s)=>{const{sso_start_url:o,sso_account_id:n,sso_region:i,sso_role_name:c}=e;if(!o||!n||!i||!c)throw new r.CredentialsProviderError(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:s});return e},Z=(e={})=>async({callerClientConfig:s}={})=>{var O;(O=e.logger)==null||O.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:o,ssoAccountId:n,ssoRegion:i,ssoRoleName:c,ssoSession:t}=e,{ssoClient:p}=e,d=r.getProfileName({profile:e.profile??(s==null?void 0:s.profile)});if(!o&&!n&&!i&&!c&&!t){const l=(await q.parseKnownFiles(e))[d];if(!l)throw new r.CredentialsProviderError(`Profile ${d} was not found.`,{logger:e.logger});if(!K(l))throw new r.CredentialsProviderError(`Profile ${d} is not configured with SSO credentials.`,{logger:e.logger});if(l!=null&&l.sso_session){const k=(await j(e))[l.sso_session],m=` configurations in profile ${d} and sso-session ${l.sso_session}`;if(i&&i!==k.sso_region)throw new r.CredentialsProviderError("Conflicting SSO region"+m,{tryNextLink:!1,logger:e.logger});if(o&&o!==k.sso_start_url)throw new r.CredentialsProviderError("Conflicting SSO start_url"+m,{tryNextLink:!1,logger:e.logger});l.sso_region=k.sso_region,l.sso_start_url=k.sso_start_url}const{sso_start_url:g,sso_account_id:f,sso_region:h,sso_role_name:a,sso_session:T}=G(l,e.logger);return b({ssoStartUrl:g,ssoSession:T,ssoAccountId:f,ssoRegion:h,ssoRoleName:a,ssoClient:p,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:d,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}else{if(!o||!n||!i||!c)throw new r.CredentialsProviderError('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger});return b({ssoStartUrl:o,ssoSession:t,ssoAccountId:n,ssoRegion:i,ssoRoleName:c,ssoClient:p,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:d,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}};exports.fromSSO=Z;exports.isSsoProfile=K;exports.validateSsoProfile=G;
//# sourceMappingURL=index-CyfE5lqx.js.map
