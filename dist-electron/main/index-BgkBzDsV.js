"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const S=require("fs/promises"),i=require("./index-B-kSrMS1.js"),b=require("./date-utils-BE7p22zv.js"),u=require("stream"),A=e=>{var t;return typeof ReadableStream=="function"&&(((t=e==null?void 0:e.constructor)==null?void 0:t.name)===ReadableStream.name||e instanceof ReadableStream)},m=async e=>{var t;return typeof Blob=="function"&&e instanceof Blob||((t=e.constructor)==null?void 0:t.name)==="Blob"?Blob.prototype.arrayBuffer!==void 0?new Uint8Array(await e.arrayBuffer()):C(e):I(e)};async function C(e){const t=await N(e),o=i.fromBase64(t);return new Uint8Array(o)}async function I(e){const t=[],o=e.getReader();let n=!1,r=0;for(;!n;){const{done:c,value:l}=await o.read();l&&(t.push(l),r+=l.length),n=c}const s=new Uint8Array(r);let a=0;for(const c of t)s.set(c,a),a+=c.length;return s}function N(e){return new Promise((t,o)=>{const n=new FileReader;n.onloadend=()=>{if(n.readyState!==2)return o(new Error("Reader aborted too early"));const r=n.result??"",s=r.indexOf(","),a=s>-1?s+1:r.length;t(r.substring(a))},n.onabort=()=>o(new Error("Read aborted")),n.onerror=()=>o(n.error),n.readAsDataURL(e)})}const y="The stream has already been transformed.",g=e=>{var r,s;if(!R(e)&&!A(e)){const a=((s=(r=e==null?void 0:e.__proto__)==null?void 0:r.constructor)==null?void 0:s.name)||e;throw new Error(`Unexpected stream implementation, expect Blob or ReadableStream, got ${a}`)}let t=!1;const o=async()=>{if(t)throw new Error(y);return t=!0,await m(e)},n=a=>{if(typeof a.stream!="function")throw new Error(`Cannot transform payload Blob to web stream. Please make sure the Blob.stream() is polyfilled.
If you are using React Native, this API is not yet supported, see: https://react-native.canny.io/feature-requests/p/fetch-streaming-body`);return a.stream()};return Object.assign(e,{transformToByteArray:o,transformToString:async a=>{const c=await o();if(a==="base64")return i.toBase64(c);if(a==="hex")return i.toHex(c);if(a===void 0||a==="utf8"||a==="utf-8")return i.toUtf8(c);if(typeof TextDecoder=="function")return new TextDecoder(a).decode(c);throw new Error("TextDecoder is not available, please make sure polyfill is provided.")},transformToWebStream:()=>{if(t)throw new Error(y);if(t=!0,R(e))return n(e);if(A(e))return e;throw new Error(`Cannot transform payload to web stream, got ${e}`)}})},R=e=>typeof Blob=="function"&&e instanceof Blob,_="The stream has already been transformed.",O=e=>{var n,r;if(!(e instanceof u.Readable))try{return g(e)}catch{const a=((r=(n=e==null?void 0:e.__proto__)==null?void 0:n.constructor)==null?void 0:r.name)||e;throw new Error(`Unexpected stream implementation, expect Stream.Readable instance, got ${a}`)}let t=!1;const o=async()=>{if(t)throw new Error(_);return t=!0,await i.streamCollector(e)};return Object.assign(e,{transformToByteArray:o,transformToString:async s=>{const a=await o();return s===void 0||Buffer.isEncoding(s)?i.fromArrayBuffer(a.buffer,a.byteOffset,a.byteLength).toString(s):new TextDecoder(s).decode(a)},transformToWebStream:()=>{if(t)throw new Error(_);if(e.readableFlowing!==null)throw new Error("The stream has been consumed by other callbacks.");if(typeof u.Readable.toWeb!="function")throw new Error("Readable.toWeb() is not supported. Please ensure a polyfill is available.");return t=!0,u.Readable.toWeb(e)}})},v="169.254.170.2",U="169.254.170.23",L="[fd00:ec2::23]",k=(e,t)=>{if(e.protocol!=="https:"&&!(e.hostname===v||e.hostname===U||e.hostname===L)){if(e.hostname.includes("[")){if(e.hostname==="[::1]"||e.hostname==="[0000:0000:0000:0000:0000:0000:0000:0001]")return}else{if(e.hostname==="localhost")return;const o=e.hostname.split("."),n=r=>{const s=parseInt(r,10);return 0<=s&&s<=255};if(o[0]==="127"&&n(o[1])&&n(o[2])&&n(o[3])&&o.length===4)return}throw new i.CredentialsProviderError(`URL not accepted. It must either be HTTPS or match one of the following:
  - loopback CIDR 127.0.0.0/8 or [::1/128]
  - ECS container host 169.254.170.2
  - EKS container host 169.254.170.23 or [fd00:ec2::23]`,{logger:t})}};function B(e){return new i.HttpRequest({protocol:e.protocol,hostname:e.hostname,port:Number(e.port),path:e.pathname,query:Array.from(e.searchParams.entries()).reduce((t,[o,n])=>(t[o]=n,t),{}),fragment:e.hash})}async function H(e,t){const n=await O(e.body).transformToString();if(e.statusCode===200){const r=JSON.parse(n);if(typeof r.AccessKeyId!="string"||typeof r.SecretAccessKey!="string"||typeof r.Token!="string"||typeof r.Expiration!="string")throw new i.CredentialsProviderError("HTTP credential provider response not of the required format, an object matching: { AccessKeyId: string, SecretAccessKey: string, Token: string, Expiration: string(rfc3339) }",{logger:t});return{accessKeyId:r.AccessKeyId,secretAccessKey:r.SecretAccessKey,sessionToken:r.Token,expiration:b.parseRfc3339DateTime(r.Expiration)}}if(e.statusCode>=400&&e.statusCode<500){let r={};try{r=JSON.parse(n)}catch{}throw Object.assign(new i.CredentialsProviderError(`Server responded with status: ${e.statusCode}`,{logger:t}),{Code:r.Code,Message:r.Message})}throw new i.CredentialsProviderError(`Server responded with status: ${e.statusCode}`,{logger:t})}const x=(e,t,o)=>async()=>{for(let n=0;n<t;++n)try{return await e()}catch{await new Promise(s=>setTimeout(s,o))}return await e()},P="AWS_CONTAINER_CREDENTIALS_RELATIVE_URI",D="http://169.254.170.2",F="AWS_CONTAINER_CREDENTIALS_FULL_URI",W="AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE",K="AWS_CONTAINER_AUTHORIZATION_TOKEN",q=(e={})=>{var h,w,T,E;(h=e.logger)==null||h.debug("@aws-sdk/credential-provider-http - fromHttp");let t;const o=e.awsContainerCredentialsRelativeUri??process.env[P],n=e.awsContainerCredentialsFullUri??process.env[F],r=e.awsContainerAuthorizationToken??process.env[K],s=e.awsContainerAuthorizationTokenFile??process.env[W],a=((T=(w=e.logger)==null?void 0:w.constructor)==null?void 0:T.name)==="NoOpLogger"||!((E=e.logger)!=null&&E.warn)?console.warn:e.logger.warn.bind(e.logger);if(o&&n&&(a("@aws-sdk/credential-provider-http: you have set both awsContainerCredentialsRelativeUri and awsContainerCredentialsFullUri."),a("awsContainerCredentialsFullUri will take precedence.")),r&&s&&(a("@aws-sdk/credential-provider-http: you have set both awsContainerAuthorizationToken and awsContainerAuthorizationTokenFile."),a("awsContainerAuthorizationToken will take precedence.")),n)t=n;else if(o)t=`${D}${o}`;else throw new i.CredentialsProviderError(`No HTTP credential provider host provided.
Set AWS_CONTAINER_CREDENTIALS_FULL_URI or AWS_CONTAINER_CREDENTIALS_RELATIVE_URI.`,{logger:e.logger});const c=new URL(t);k(c,e.logger);const l=i.NodeHttpHandler.create({requestTimeout:e.timeout??1e3,connectionTimeout:e.timeout??1e3});return x(async()=>{const d=B(c);r?d.headers.Authorization=r:s&&(d.headers.Authorization=(await S.readFile(s)).toString());try{const f=await l.handle(d);return H(f.response).then(p=>i.setCredentialFeature(p,"CREDENTIALS_HTTP","z"))}catch(f){throw new i.CredentialsProviderError(String(f),{logger:e.logger})}},e.maxRetries??3,e.timeout??1e3)};exports.fromHttp=q;
//# sourceMappingURL=index-BgkBzDsV.js.map
